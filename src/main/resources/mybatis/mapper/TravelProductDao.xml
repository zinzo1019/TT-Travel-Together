<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.choyoujin.dao.TravelProductDao">

    <!--    모든 상품 가져오기-->
    <select id="findAllProducts" resultType="com.example.choyoujin.dto.ProductDto">
        select *
        from travel_product tp
                 LEFT JOIN travel_product_image tpi
                           on tp.travel_product_image_id = tpi.id
    </select>

    <!--    나라별 여행 상품 아이디 리스트 가져오기-->
    <select id="findAllProductIdsByCountryId" resultType="int">
        select *
        from travel_product tp
                 LEFT JOIN travel_product_image tpi
                           on tp.travel_product_image_id = tpi.id
        where country_id = #{countryId}
    </select>

    <!--    사용자 좋아요별 여행 상품 리스트 가져오기-->
    <select id="findAllByUserLike" resultType="com.example.choyoujin.dto.ProductDto">
        select *
        from travel_product tp
                 left join product_like pl
                           on tp.id = pl.travel_product_id
                 left join country c
                           on tp.country_id = c.id
                 LEFT JOIN travel_product_image tpi
                           on tp.travel_product_image_id = tpi.id
        where pl.tb_user_id = #{userId}
    </select>

    <!--    나라별 상품 가져오기 - 로그인 후 (좋아요 O)-->
    <select id="findAllProductsByCountryIdAndUserId" resultType="com.example.choyoujin.dto.ProductDto">
        select distinct tp.id,
                        tp.tb_user_id as userId,
                        tp.*,
                        tpi.*,
                        case
                            when pl.tb_user_id = #{userId}
                                then true
                            else false
                            end       as userLiked
        from travel_product tp
                 left join product_like pl
                           on tp.id = pl.travel_product_id
                 LEFT JOIN travel_product_image tpi
                           on tp.travel_product_image_id = tpi.id
        where country_id = #{countryId}
        order by tp.like desc
    </select>

    <!--    나라별 상품 가져오기 - 로그인 전 (좋아요 X)-->
    <select id="findAllProductsByCountryId" resultType="com.example.choyoujin.dto.ProductDto">
        select tb_user_id as userId, tp.*, tpi.*
        from travel_product tp
                 LEFT JOIN travel_product_image tpi
                           on tp.travel_product_image_id = tpi.id
        where tp.country_id = #{countryId}
        order by tp.like desc
    </select>

    <!--    나라별 여행 상품 리스트 중 검색하기 (name과 description 고려) - 로그인 전-->
    <select id="findAllProductsByCountryIdAndKeyword" resultType="com.example.choyoujin.dto.ProductDto">
        SELECT tb_user_id AS userId, tp.*, tpi.*
        FROM travel_product tp
        LEFT JOIN travel_product_image tpi
        on tp.travel_product_image_id = tpi.id
        WHERE (tp.name LIKE '%' || #{keyword} || '%'
            OR tp.description LIKE '%' || #{keyword} || '%')
          AND tp.country_id = #{countryId}
        ORDER BY tp.like DESC
    </select>

    <!--    나라별 여행 상품 리스트 중 검색하기 (name과 description 고려) - 로그인 후-->
    <select id="findAllProductsByCountryIdAndKeywordAndUserId" resultType="com.example.choyoujin.dto.ProductDto">
        SELECT tp.tb_user_id AS userId, tp.*, tpi.*
        FROM travel_product tp
                 LEFT JOIN travel_product_image tpi
                           on tp.travel_product_image_id = tpi.id
        WHERE (tp.name LIKE '%' || #{keyword} || '%'
            OR tp.description LIKE '%' || #{keyword} || '%')
          AND tp.country_id = #{countryId}
        ORDER BY tp.like DESC
    </select>

    <!--    여행 상품 리스트 검색하기 (name과 description 고려)-->
    <select id="findAllProductsByKeywordAndUserId" resultType="com.example.choyoujin.dto.ProductDto">
        SELECT tp.*, c.*, tpi.*
        FROM travel_product tp
                 LEFT JOIN country c
                           ON tp.country_id = c.id
                 LEFT JOIN travel_product_image tpi
                           on tp.travel_product_image_id = tpi.id
        WHERE (tp.name LIKE '%' || #{keyword} || '%'
            OR tp.description LIKE '%' || #{keyword} || '%'
            OR c.country LIKE '%' || #{keyword} || '%'
            OR c.city LIKE '%' || #{keyword} || '%')
        order by tp.like desc
    </select>

    <!--    아이디로 상품 가져오기 - 로그인 전 (좋아요 X)-->
    <select id="findProductByProductId" resultType="com.example.choyoujin.dto.ProductDto">
        select tp.tb_user_id as userId, tp.*, c.*, tpi.*
        from travel_product tp
                 left join country c
                           on tp.country_id = c.id
                 LEFT JOIN travel_product_image tpi
                           on tp.travel_product_image_id = tpi.id
        where tp.id = #{productId}
    </select>

    <!--    아이디로 상품 가져오기 - 로그인 후 (좋아요 O)-->
    <select id="findProductByProductIdAndUserId" resultType="com.example.choyoujin.dto.ProductDto">
        select tp.tb_user_id as userId,
               tp.*,
               c.*,
               tpi.*,
               case
                   when pl.tb_user_id = #{userId}
                       then true
                   else false
                   end       as userLiked
        from travel_product tp
                 left join country c
                           on tp.country_id = c.id
                 left join product_like pl
                           on tp.id = pl.travel_product_id
                 LEFT JOIN travel_product_image tpi
                           on tp.travel_product_image_id = tpi.id
        where tp.id = #{productId}
    </select>

    <!--    관리자 - 사용자 아이디로 상품 리스트 가져오기-->
    <select id="findAllProductsByUserId" resultType="com.example.choyoujin.dto.ProductDto">
        SELECT tp.*, tp.tb_user_id as userId, c.*, tpi.*
        FROM travel_product tp
                 LEFT JOIN country c ON tp.country_id = c.id
                 LEFT JOIN travel_product_image tpi
                           on tp.travel_product_image_id = tpi.id
        WHERE tp.tb_user_id = #{userId}
        ORDER BY c.country, c.city, tp.like DESC
    </select>

    <!--    여행 상품 등록하기-->
    <insert id="saveProduct" useGeneratedKeys="true" parameterType="com.example.choyoujin.dto.ProductDto"
            keyProperty="id">
        insert into travel_product (name, description, cost, tb_user_id, country_id, travel_product_image_id)
        values (#{productName}, #{description}, #{cost}, #{userId}, #{countryId}, #{imageId})
    </insert>

    <!--    여행 상품 - 설명 저장하기-->
    <insert id="saveProductDetails">
        insert into travel_product_detail (description, travel_product_id)
        values
        <foreach item="detail" collection="details" separator=",">
            (#{detail}, #{productId})
        </foreach>
    </insert>

    <!--    여행 상품 - 태그 저장하기-->
    <insert id="saveProductTags">
        insert into travel_product_tag (tag, travel_product_id)
        values
        <foreach item="tag" collection="tags" separator=",">
            (#{tag}, #{productId})
        </foreach>
    </insert>

    <!--    여행 상품 - 좋아요 1 증가-->
    <update id="plusLike">
        update travel_product
        set "like" = "like" + 1
        where id = #{productId}
    </update>

    <!--    여행 상품 - 좋아요 1 감소-->
    <update id="plusUnLike">
        update travel_product
        set "like" = "like" - 1
        where id = #{productId}
    </update>

    <!--    쿠폰 등록 - 나라 아이디로 여행 상품 리스트 가져오기-->
    <select id="findAllByCountryId" resultType="com.example.choyoujin.dto.ProductDto">
        SELECT id, name, country_id
        FROM travel_product
        WHERE country_id = #{countryId}
        ORDER BY id
    </select>
</mapper>